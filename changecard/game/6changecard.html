<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>遊戲介面</title>
    <link rel="stylesheet" href="static/style4.css"> <!-- 引入CSS -->
</head>
<body onload="previewAllCards()">
    <div id="timer-container">
        時間: <span id="timer2">0</span> 秒<br>
        翻開提醒次數: <span id="count2"></span> 次
    </div>
    <span id="timer1" style="font-size: 64px; font-weight: bold;text-align: center;"></span>
    <form>
        <input type="button" class="card-button" id="option1" value="?">
        <input type="button" class="card-button" id="option2" value="?">
        <input type="button" class="card-button" id="option3" value="?">
        <input type="button" class="card-button" id="option4" value="?">
        <input type="button" class="card-button" id="option5" value="?">
        <input type="button" class="card-button" id="option6" value="?">
        <input type="button" class="card-button" id="option7" value="?">
        <input type="button" class="card-button" id="option8" value="?">
        <input type="button" class="card-button" id="option9" value="?">
        <input type="button" class="card-button" id="option10" value="?">
        <input type="button" class="card-button" id="option11" value="?">
        <input type="button" class="card-button" id="option12" value="?">
    </form>
    <div id="gameOverScreen" style="display: none; text-align: center;">
        <h2>時間到！遊戲結束！</h2>
      </div>
      <script>
        var i;
        var emojis = ['🍎', '🍌', '🍎', '🍌','🍐','🍐','🍋','🍋','🍉','🍉','🍇','🍇'];
        var Button = document.getElementById("option1");
        var Button2 = document.getElementById("option2");
        var Button3 = document.getElementById("option3");
        var Button4 = document.getElementById("option4");
        var Button5 = document.getElementById("option5");
        var Button6 = document.getElementById("option6");
        var Button7 = document.getElementById("option7");
        var Button8 = document.getElementById("option8");
        var Button9 = document.getElementById("option9");
        var Button10 = document.getElementById("option10");
        var Button11 = document.getElementById("option11");
        var Button12 = document.getElementById("option12");

        Button.addEventListener("click", function() { startGame(Button, 0); });
        Button2.addEventListener("click", function() { startGame(Button2, 1); });
        Button3.addEventListener("click", function() { startGame(Button3, 2); });
        Button4.addEventListener("click", function() { startGame(Button4, 3); });
        Button5.addEventListener("click", function() { startGame(Button5, 4); });
        Button6.addEventListener("click", function() { startGame(Button6, 5); });
        Button7.addEventListener("click", function() { startGame(Button7, 6); });
        Button8.addEventListener("click", function() { startGame(Button8, 7); });
        Button9.addEventListener("click", function() { startGame(Button9, 8); });
        Button10.addEventListener("click", function() { startGame(Button10, 9); });
        Button11.addEventListener("click", function() { startGame(Button11, 10); });
        Button12.addEventListener("click", function() { startGame(Button12, 11); });

        function shuffle(array){
            for(i=array.length-1;i>0;i--){
                var j = Math.floor(Math.random()*(i+1));
                [array[i], array[j]] = [array[j], array[i]];//互換牌
            }
            return array
        }

        let shuffled = shuffle(emojis)
        let interval;
        var card=[];
        var card2=[];
        var matchedCount = 0; 
        var count; 
        count = parseInt(localStorage.getItem("count1")) || 0;
        document.getElementById("count2").innerText = count;
         function previewAllCards() {
            shuffled = shuffle(emojis)
                const buttons = [Button, Button2, Button3, Button4, Button5, Button6, Button7, Button8, Button9, Button10, Button11, Button12];

                buttons.forEach((btn, i) => {
                    btn.value = shuffled[i];
                    btn.disabled = true;
                });

                let previewCountdown = 5;
                    document.getElementById("timer1").innerText = "記憶倒數時間:"+previewCountdown
                    const previewInterval = setInterval(() => {
                        previewCountdown--;
                        document.getElementById("timer1").innerText = "記憶倒數時間:"+previewCountdown;

                        if (previewCountdown === 0) {
                            clearInterval(previewInterval);
                            document.getElementById("timer1").innerText = "遊戲開始!!!";


                            // 蓋牌並啟用按鈕
                            buttons.forEach((btn, i) => {
                                btn.value = "?";
                                btn.disabled = false;
                             });

                         // 啟動正式計時
                            let countdown = 0;
                            document.getElementById("timer2").innerText = countdown;
                            interval = setInterval(() => {
                            countdown++;
                            localStorage.setItem("timer2", countdown);
                            document.getElementById("timer2").innerText = countdown;
                            }, 1000);
                        }
                    }, 1000);
            }
        function startGame(button, index) {
                    if (isRevealing) return;  // ➤ 如果正在提示，就不執行點擊邏輯
                    if (card.length < 2 && !card2.includes(button)) {  // 限制最多翻兩張卡，且同一按鈕不能點兩次
                        button.value = shuffled[index];
                        card.push(shuffled[index]); // 儲存 emoji
                        card2.push(button);         // 儲存按鈕
                           
                        if (card.length === 2) {
                            setTimeout(function () {
                                if (card[0] === card[1]) {
                                    card2[0].disabled = true;
                                    card2[1].disabled = true;

                                    card2[0].value = card[0];
                                    card2[1].value = card[1];

                                    card2[0].classList.add("matched");
                                    card2[1].classList.add("matched");

                                    matchedCount += 2;  // ✅ 每次成功配對加 2

                                    // ✅ 若所有牌都配對成功，就導向結果頁
                                    if (matchedCount === emojis.length) {
                                        clearInterval(interval);  // 停止倒數
                                        clearInterval(revealInterval);
                                        window.location.href = "/changecarddone4";
                                    }
                                } else {
                                    card2[0].value = "?";
                                    card2[1].value = "?";
                                }
                                card2 = [];
                                card = [];//重置
                            }, 500);  // 等待 1 秒後檢查是否配對
                        }
                    }
                }
                let revealInterval = setInterval(revealAllCards, 25000);
                let isRevealing = false;  // ➤ 加這個變數
                function revealAllCards() {
                    isRevealing = true; // ➤ 開始提示時，禁止點擊
                    let buttons = document.querySelectorAll(".card-button");
                    count = count+1;
                    document.getElementById("count2").innerText = count;
                    localStorage.setItem("count2", count);
                    // 揭示期間，全部按鈕禁用（無法點擊）
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        
                    });

                    // 顯示所有未配對卡片
                    buttons.forEach((btn, index) => {
                        if (!btn.classList.contains("matched")) {
                            btn.dataset.index = index; // ✅ 存下正確的 index
                            btn.value = shuffled[index];
                            
                            btn.style.backgroundColor = "#6495ED";  // 或你原本的背景色
                            btn.style.color = "black";
                            btn.style.opacity = "1";
                            btn.style.border = "1px solid #999";
                            btn.style.cursor = "default";
                        }
                    });

                    // 5秒後蓋回未配對卡片，並開放點擊
                    setTimeout(() => {
                        buttons.forEach(btn => {
                            if (!btn.classList.contains("matched")) {
                                btn.value = "?";
                                btn.disabled = false;
                                
                                btn.style.backgroundColor = ""; 
                                btn.style.color = "";
                                btn.style.opacity = "";
                                btn.style.border = "";
                                btn.style.cursor = "";
                            } else {
                                btn.disabled = true;
                                // ✅ 使用事先儲存的 index
                                let idx = btn.dataset.index;
                                if (idx !== undefined) {
                                    btn.value = shuffled[idx];
                                }
                            }
                        });
                        isRevealing = false; // ➤ 提示結束，允許點擊
                    }, 5000);
            }
        buttons.forEach((btn, i) => {
            btn.addEventListener("click", () => startGame(btn, i));
        });

        window.onload = previewAllCards;
    </script>
</body>
</html>
