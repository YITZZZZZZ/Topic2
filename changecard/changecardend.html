<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>遊戲結束</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: "Noto Sans TC", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e3f0ff, #ffffff);
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: #2c3e50;
      padding: 1rem;
      user-select: none;
    }

    @keyframes fadeSlideUp {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .container {
      background-color: #fff;
      padding: 2.5rem 3rem;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(92, 124, 171, 0.15);
      width: 100%;
      max-width: 500px;
      text-align: center;
      user-select: text;
      animation: fadeSlideUp 0.8s ease forwards;
    }

    h1 {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 2rem;
      letter-spacing: 2px;
      color: #1e3a8a;
      text-shadow: 0 1px 3px rgba(30, 58, 138, 0.3);
    }

    .result-box, .result-box1 {
      background-color: #f4f8ff;
      border-radius: 20px;
      padding: 2rem 2.2rem;
      margin-bottom: 2rem;
      box-shadow: inset 0 0 10px #d0defa;
      color: #324a8e;
      font-size: 1.4rem;
      line-height: 1.6;
      text-align: left;
    }

    .result-box h2 {
      margin-top: 1.2rem;
      font-weight: 700;
      font-size: 1.7rem;
      color: #2a3c82;
      user-select: text;
    }

    .result-box > div, .result-box1 > div {
      margin-bottom: 0.8rem;
    }

    .result-box1 h3 {
      font-weight: 600;
      font-size: 1.3rem;
      color: #4255a4;
      margin-top: 0.3rem;
      user-select: text;
    }

    @keyframes buttonClick {
      0% {
        transform: scale(1);
        box-shadow: 0 12px 28px rgba(107, 129, 247, 0.6);
      }
      50% {
        transform: scale(0.9);
        box-shadow: 0 6px 14px rgba(107, 129, 247, 0.3);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 12px 28px rgba(107, 129, 247, 0.6);
      }
    }

    /* 三按鈕統一區塊 */
    .buttons {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      user-select: none;
      margin-top: 1.5rem;
      flex-wrap: nowrap;
    }

    /* 共有按鈕基礎樣式 */
    .buttons button {
      flex: 1 1 0;
      padding: 14px 0;
      border-radius: 30px;
      border: none;
      font-size: 1.3rem;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(79, 103, 216, 0.4);
      transition: all 0.3s ease;
      user-select: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .buttons button:hover, .buttons button:focus {
      transform: scale(1.05);
      outline: none;
    }
    .buttons button:active {
      animation: buttonClick 0.3s ease forwards;
    }

    /* 各按鈕特化顏色 */
    .buttons .play-again {
      background-image: linear-gradient(135deg, #4f67d8, #8a9efb);
      box-shadow: 0 8px 20px rgba(79, 103, 216, 0.4);
    }
    .buttons .play-again:hover, .buttons .play-again:focus {
      background-image: linear-gradient(135deg, #6b81f7, #b0beff);
      box-shadow: 0 16px 40px rgba(107, 129, 247, 0.8);
    }

    .buttons .exit-btn {
      background-image: linear-gradient(135deg, #e94b4b, #f49797);
      box-shadow: 0 8px 20px rgba(233, 75, 75, 0.4);
    }
    .buttons .exit-btn:hover, .buttons .exit-btn:focus {
      background-image: linear-gradient(135deg, #f26a6a, #f9a2a2);
      box-shadow: 0 16px 40px rgba(242, 106, 106, 0.8);
    }

    .buttons .export-btn {
      background-image: linear-gradient(135deg, #36c35b, #75d48a);
      box-shadow: 0 8px 20px rgba(54, 195, 91, 0.45);
      font-size: 1.3rem;
      font-weight: 700;
    }
    .buttons .export-btn:hover, .buttons .export-btn:focus {
      background-image: linear-gradient(135deg, #4edd6d, #93e3a0);
      box-shadow: 0 16px 40px rgba(78, 221, 109, 0.9);
    }

    /* 使用者資訊 */
    .user-info {
      position: fixed;
      top: 1rem;
      right: 1.5rem;
      background: rgba(255 255 255 / 0.9);
      padding: 0.5rem 1rem;
      border-radius: 18px;
      box-shadow: 0 6px 20px rgba(92, 124, 171, 0.15);
      font-weight: 600;
      font-size: 1.7rem;
      color: #2a3c82;
      display: flex;
      gap: 1rem;
      align-items: center;
      user-select: none;
      z-index: 10;
      animation: fadeSlideUp 0.8s ease forwards;
    }
    .user-info button {
      padding: 8px 16px;
      border-radius: 12px;
      border: none;
      background: #b2c7ff;
      font-weight: 700;
      font-size: 1.1rem;
      color: #2a3c82;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(178, 199, 255, 0.6);
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .user-info button:hover, .user-info button:focus {
      background-color: #8aaaff;
      outline: none;
    }
    .user-info button:active {
      transform: scale(0.95);
    }

    /* 響應式手機版 */
    @media (max-width: 520px) {
      .container {
        padding: 2rem 1.5rem;
      }
      h1 {
        font-size: 2.2rem;
      }
      .result-box, .result-box1 {
        font-size: 1.2rem;
        padding: 1.6rem 1.8rem;
      }
      .buttons {
        flex-direction: column;
        gap: 1rem;
      }
      .buttons button {
        width: 100%;
        font-size: 1.2rem;
      }
      .user-info {
        font-size: 1.3rem;
        top: 0.8rem;
        right: 1rem;
        padding: 0.3rem 0.8rem;
      }
      .user-info button {
        font-size: 1rem;
        padding: 6px 12px;
      }
    }
  </style>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="user-info" role="region" aria-label="使用者資訊">
    <span id="username">您好，訪客</span>
    <button aria-label="登出按鈕" onclick="logout()">登出</button>
  </div>

  <div class="container" role="main" aria-labelledby="gameEndTitle">
    <h1 id="gameEndTitle">遊戲結束</h1>

    <div class="result-box" aria-live="polite">
      <div>版本: <span id="level"></span></div>
      <div>第一關用時: <span id="usedTime1"></span> 秒</div>
      <div>第二關用時: <span id="usedTime2"></span> 秒</div>
      <div>第三關用時: <span id="usedTime3"></span> 秒</div>
      <h2>三項翻牌機制平均用時: <span id="usedTime"></span> 秒</h2>
      <h2>總翻牌提醒次數: <span id="count"></span> 次</h2>
    </div>

    <div class="result-box1">
      <div>建議:
        <h3 id="Suggestion"></h3>
      </div>
    </div>

    <div class="buttons" role="group" aria-label="操作按鈕">
      <button class="play-again" onclick="location.href='/changecardstart'; clearData()">再玩一次</button>
      <button class="exit-btn" onclick="location.href='/gameselect'; clearData()">退出</button>
      <button class="export-btn" id="exportBtn" onclick="exportGameData()">匯出遊戲報表</button>
    </div>
  </div>

  <script>
    var timeLeft1 = localStorage.getItem("timer1");
    var timeLeft2 = localStorage.getItem("timer2");
    var timeLeft3 = localStorage.getItem("timer3");
    var count1 = localStorage.getItem("count3");
    var level = localStorage.getItem("test");

    if(level=="練習版"){
       document.getElementById("level").innerText = level;
       if(timeLeft1){
          document.getElementById("usedTime1").innerText = timeLeft1;
          document.getElementById("usedTime2").innerText = " ";
          document.getElementById("usedTime3").innerText = " ";
          document.getElementById("usedTime").innerText = (parseInt(timeLeft1))
          document.getElementById("count").innerText = count1 || "0";
       }
       else{
          document.getElementById("usedTime").innerText = "NA";
       }
    }else{
       document.getElementById("level").innerText = level;
        if (timeLeft1 && timeLeft2 && timeLeft3) {
          document.getElementById("usedTime1").innerText = timeLeft1;
          document.getElementById("usedTime2").innerText = timeLeft2;
          document.getElementById("usedTime3").innerText = timeLeft3;
          document.getElementById("usedTime").innerText = ((parseInt(timeLeft1)+parseInt(timeLeft2)+parseInt(timeLeft3))/3).toFixed(2);
          document.getElementById("count").innerText = count1 || "0";
        } else {
          document.getElementById("usedTime").innerText = "NA";
        }
    }

    const username = localStorage.getItem("nickname") || "訪客";
    document.getElementById("username").textContent = `您好，${username}`;

    function clearData(){
      localStorage.clear();
    }

    function logout() {
      clearData();
      location.href = "/";
    }

    function exportGameData() {
      const records = JSON.parse(localStorage.getItem("gameResults") || "[]");
      if (records.length === 0) {
        alert("沒有遊戲紀錄可匯出！");
        return;
      }
      const ws = XLSX.utils.json_to_sheet(records);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "遊戲紀錄");
      XLSX.writeFile(wb, "game_results_" + username + ".xlsx");
      // 若需保留紀錄可註解掉下面一行
      localStorage.removeItem("gameResults");
    }
  </script>
</body>
</html>
